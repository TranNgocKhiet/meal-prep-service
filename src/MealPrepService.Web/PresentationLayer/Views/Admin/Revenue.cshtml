@model MealPrepService.Web.PresentationLayer.ViewModels.RevenueReportsListViewModel

@{
    ViewData["Title"] = "Revenue Reports";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> Revenue Reports</h2>
        <div>
            <a asp-action="Dashboard" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Year Selection -->
    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="Revenue" method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="year" class="form-label">Select Year</label>
                    <select class="form-select" id="year" name="year" onchange="this.form.submit()" data-placeholder="Select a year...">
                        @foreach (var year in Model.AvailableYears)
                        {
                            if (year == Model.SelectedYear)
                            {
                                <option value="@year" selected>@year</option>
                            }
                            else
                            {
                                <option value="@year">@year</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-8">
                    <form asp-action="GenerateMonthlyReport" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="year" value="@Model.SelectedYear" />
                        <input type="hidden" name="month" value="@DateTime.Now.Month" />
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-file-earmark-plus"></i> Generate Current Month Report
                        </button>
                    </form>
                </div>
            </form>
        </div>
    </div>

    <!-- Yearly Summary -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-calendar-check"></i> @Model.YearlySummary.Year Summary</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h6 class="text-muted mb-2">Total Revenue</h6>
                        <h3 class="text-primary mb-0">@Model.YearlySummary.TotalRevenue.ToString("C")</h3>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h6 class="text-muted mb-2">Order Revenue</h6>
                        <h3 class="text-success mb-0">@Model.YearlySummary.TotalOrderRevenue.ToString("C")</h3>
                        <small class="text-muted">@Model.YearlySummary.TotalOrders orders</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h6 class="text-muted mb-2">Subscription Revenue</h6>
                        <h3 class="text-info mb-0">@Model.YearlySummary.TotalSubscriptionRevenue.ToString("C")</h3>
                        <small class="text-muted">Deferred to Checkpoint 2</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h6 class="text-muted mb-2">Avg Monthly Revenue</h6>
                        <h3 class="text-secondary mb-0">@Model.YearlySummary.AverageMonthlyRevenue.ToString("C")</h3>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.YearlySummary.BestMonth))
            {
                <div class="alert alert-success mt-3 mb-0">
                    <i class="bi bi-trophy-fill"></i> 
                    <strong>Best Performing Month:</strong> @Model.YearlySummary.BestMonth with 
                    <strong>@Model.YearlySummary.BestMonthRevenue.ToString("C")</strong> in revenue
                </div>
            }
        </div>
    </div>

    <!-- Monthly Reports Table -->
    @if (Model.HasReports)
    {
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-table"></i> Monthly Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Order Revenue</th>
                                <th class="text-end">Subscription Revenue</th>
                                <th class="text-end">Total Revenue</th>
                                <th class="text-end">Orders</th>
                                <th class="text-end">Avg Order Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in Model.MonthlyReports)
                            {
                                <tr>
                                    <td><strong>@report.MonthName</strong></td>
                                    <td class="text-end">
                                        @if (report.HasOrderRevenue)
                                        {
                                            <span class="text-success">@report.TotalOrderRevenue.ToString("C")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">$0.00</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (report.HasSubscriptionRevenue)
                                        {
                                            <span class="text-info">@report.TotalSubscriptionRevenue.ToString("C")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">$0.00</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-primary">@report.TotalRevenue.ToString("C")</strong>
                                    </td>
                                    <td class="text-end">
                                        @if (report.HasOrders)
                                        {
                                            <span>@report.TotalOrdersCount</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (report.HasOrders)
                                        {
                                            <span>@report.AverageOrderValue.ToString("C")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th>Total</th>
                                <th class="text-end text-success">@Model.YearlySummary.TotalOrderRevenue.ToString("C")</th>
                                <th class="text-end text-info">@Model.YearlySummary.TotalSubscriptionRevenue.ToString("C")</th>
                                <th class="text-end text-primary"><strong>@Model.YearlySummary.TotalRevenue.ToString("C")</strong></th>
                                <th class="text-end">@Model.YearlySummary.TotalOrders</th>
                                <th class="text-end">-</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Revenue Chart (Placeholder for future implementation) -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Revenue Trends</h5>
            </div>
            <div class="card-body">
                <div class="text-center py-5">
                    <i class="bi bi-bar-chart" style="font-size: 4rem; color: #ccc;"></i>
                    <h5 class="mt-3 text-muted">Chart Visualization</h5>
                    <p class="text-muted">Revenue trend chart will be displayed here</p>
                    <small class="text-muted">
                        Chart data available: @Model.ChartData.Count months
                    </small>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-graph-up" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3">No Revenue Reports Available</h4>
                <p class="text-muted">No reports have been generated for @Model.SelectedYear yet.</p>
                <form asp-action="GenerateMonthlyReport" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="year" value="@Model.SelectedYear" />
                    <input type="hidden" name="month" value="@DateTime.Now.Month" />
                    <button type="submit" class="btn btn-primary mt-2">
                        <i class="bi bi-file-earmark-plus"></i> Generate Current Month Report
                    </button>
                </form>
            </div>
        </div>
    }

    <!-- Note about deferred features -->
    <div class="alert alert-info mt-4">
        <i class="bi bi-info-circle"></i> 
        <strong>Note:</strong> Subscription revenue calculations are deferred to Checkpoint 2. 
        Current reports show order revenue only.
    </div>
</div>

<style>
    .table tbody tr {
        transition: background-color 0.2s;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .bg-light.rounded {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .bg-light.rounded:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
