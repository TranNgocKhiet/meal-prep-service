@model AddMealToPlanViewModel
@{
    ViewData["Title"] = "Add Meal to Plan";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-plus-circle me-2" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Add Meal to @ViewBag.PlanName
                    </h4>
                    <small class="text-light">Plan Duration: @ViewBag.StartDate.ToString("MMM dd, yyyy") - @ViewBag.EndDate.ToString("MMM dd, yyyy")</small>
                </div>
                <div class="card-body">
                    <form asp-action="AddMeal" method="post" id="addMealForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <input type="hidden" asp-for="PlanId" />

                        <!-- Meal Details Section -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="MealType" class="form-label fw-bold"></label>
                                <select asp-for="MealType" class="form-select">
                                    <option value="">Select meal type...</option>
                                    @foreach (var mealType in AddMealToPlanViewModel.MealTypeOptions)
                                    {
                                        <option value="@mealType">@mealType</option>
                                    }
                                </select>
                                <span asp-validation-for="MealType" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ServeDate" class="form-label fw-bold"></label>
                                <input asp-for="ServeDate" class="form-control" type="date" />
                                <span asp-validation-for="ServeDate" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Action Buttons - Moved here -->
                        <div class="d-flex justify-content-between mb-4">
                            <a asp-action="Details" asp-route-id="@Model.PlanId" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                                </svg>
                                Back to Plan
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="addMealBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle me-2" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                </svg>
                                Add Meal to Plan
                            </button>
                        </div>

                        <hr />

                        <!-- Recipe Search Section -->
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search me-2" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                                Search Recipes
                            </h5>
                            <div class="alert alert-info">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                </svg>
                                Search for recipes by name to add to your meal. Select one or more recipes and view their ingredients.
                            </div>
                    </form>

                    <!-- Search Form (separate from main form) -->
                    <form asp-action="AddMeal" method="get" class="mb-4">
                        <input type="hidden" name="planId" value="@Model.PlanId" />
                        <div class="input-group">
                            <input type="text" 
                                   name="searchTerm" 
                                   class="form-control form-control-lg" 
                                   placeholder="Search recipes by name..." 
                                   value="@Model.SearchTerm"
                                   autofocus />
                            <button type="submit" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                                Search
                            </button>
                            @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                            {
                                <a asp-action="AddMeal" asp-route-planId="@Model.PlanId" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle me-1" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                    Clear
                                </a>
                            }
                        </div>
                    </form>

                    <!-- Recipe Results Section -->
                    @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                    {
                        @if (Model.AvailableRecipes.Any())
                        {
                            <div class="alert alert-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle me-2" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                </svg>
                                Found <strong>@Model.AvailableRecipes.Count</strong> recipe@(Model.AvailableRecipes.Count != 1 ? "s" : "") matching "@Model.SearchTerm"
                            </div>

                            <div class="row" id="recipeGrid">
                                @for (int i = 0; i < Model.AvailableRecipes.Count; i++)
                                {
                                    var recipe = Model.AvailableRecipes[i];
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card recipe-card h-100" data-recipe-id="@recipe.Id">
                                            <div class="card-body">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input recipe-checkbox" 
                                                           type="checkbox" 
                                                           name="SelectedRecipeIds" 
                                                           value="@recipe.Id" 
                                                           id="recipe_@recipe.Id"
                                                           form="addMealForm"
                                                           @(recipe.IsSelected ? "checked" : "") />
                                                    <label class="form-check-label fw-bold" for="recipe_@recipe.Id">
                                                        @recipe.RecipeName
                                                    </label>
                                                </div>

                                                <!-- Nutrition Info -->
                                                <div class="nutrition-info mb-3">
                                                    <div class="row text-center">
                                                        <div class="col-6 mb-1">
                                                            <small class="text-muted">Calories</small>
                                                            <div class="fw-bold">@recipe.TotalCalories.ToString("F0")</div>
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <small class="text-muted">Protein</small>
                                                            <div class="fw-bold">@recipe.ProteinG.ToString("F1")g</div>
                                                        </div>
                                                        <div class="col-6">
                                                            <small class="text-muted">Fat</small>
                                                            <div class="fw-bold">@recipe.FatG.ToString("F1")g</div>
                                                        </div>
                                                        <div class="col-6">
                                                            <small class="text-muted">Carbs</small>
                                                            <div class="fw-bold">@recipe.CarbsG.ToString("F1")g</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Ingredients Section -->
                                                @if (recipe.Ingredients?.Any() == true)
                                                {
                                                    <div class="ingredients-section" style="display: @(recipe.IsSelected ? "block" : "none");">
                                                        <h6 class="text-muted mb-2">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-list-ul me-1" viewBox="0 0 16 16">
                                                                <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                                            </svg>
                                                            Ingredients:
                                                        </h6>
                                                        @foreach (var ingredient in recipe.Ingredients)
                                                        {
                                                            <div class="ingredient-item mb-2 p-2 bg-light rounded">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span class="fw-medium">@ingredient.IngredientName</span>
                                                                    <span class="text-muted">@ingredient.Amount @ingredient.Unit</span>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-muted small">No ingredients specified for this recipe.</div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle me-2" viewBox="0 0 16 16">
                                    <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.146.146 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.163.163 0 0 1-.054.06.116.116 0 0 1-.066.017H1.146a.115.115 0 0 1-.066-.017.163.163 0 0 1-.054-.06.176.176 0 0 1 .002-.183L7.884 2.073a.147.147 0 0 1 .054-.057zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z"/>
                                    <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z"/>
                                </svg>
                                No recipes found matching "<strong>@Model.SearchTerm</strong>". Try a different search term.
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-search text-muted mb-3" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                            <h5 class="text-muted">Search for recipes to add to your meal</h5>
                            <p class="text-muted">Enter a recipe name in the search box above to get started.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const recipeCheckboxes = document.querySelectorAll('.recipe-checkbox');
            const addMealBtn = document.getElementById('addMealBtn');
            
            // Handle recipe selection
            recipeCheckboxes.forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    const recipeCard = this.closest('.recipe-card');
                    const ingredientsSection = recipeCard.querySelector('.ingredients-section');
                    
                    if (this.checked) {
                        recipeCard.classList.add('selected');
                        if (ingredientsSection) {
                            ingredientsSection.style.display = 'block';
                        }
                    } else {
                        recipeCard.classList.remove('selected');
                        if (ingredientsSection) {
                            ingredientsSection.style.display = 'none';
                        }
                    }
                    
                    updateAddButtonState();
                });
            });
            
            // Update add button state based on selection
            function updateAddButtonState() {
                const selectedRecipes = document.querySelectorAll('.recipe-checkbox:checked');
                addMealBtn.disabled = selectedRecipes.length === 0;
                
                if (selectedRecipes.length === 0) {
                    addMealBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle me-2" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/></svg>Select at least one recipe';
                } else {
                    addMealBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle me-2" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg>Add ' + selectedRecipes.length + ' Recipe' + (selectedRecipes.length > 1 ? 's' : '') + ' to Plan';
                }
            }
            
            // Initialize button state
            updateAddButtonState();
        });
    </script>
    
    <style>
        .recipe-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .recipe-card.selected {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .nutrition-info {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.75rem;
        }
        
        .ingredient-item {
            border-left: 3px solid #0d6efd;
        }
        
        .ingredient-amount.modified {
            font-weight: bold;
        }
        
        #addMealBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
}
